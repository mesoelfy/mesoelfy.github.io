name: Release Pipeline

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # 1. BUILD WEB VERSION
  build-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: 'npm' }
      - run: npm ci
      - run: npm run build
      - run: cd out && zip -r ../MESOELFY_OS_Itch_Upload_Ready.zip .
      - uses: actions/upload-artifact@v4
        with:
          name: web-artifact
          path: MESOELFY_OS_Itch_Upload_Ready.zip

  # 2. BUILD DESKTOP APPS
  build-desktop:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: 'npm' }
      - run: npm ci
      
      - name: Install Linux Deps
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y libicns-dev graphicsmagick

      - name: Build Next.js
        run: npm run build

      - name: Build Electron
        # Build but do not publish to GitHub yet (we do that manually in step 3)
        run: npx electron-builder --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload raw files to temp storage
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-artifacts-${{ matrix.os }}
          path: |
            dist/*.exe
            dist/*.dmg
            dist/*.AppImage

  # 3. CURATE AND PUBLISH
  publish:
    needs: [build-web, build-desktop]
    runs-on: ubuntu-latest
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: '*'
          merge-multiple: true

      - name: Bundle and Clean
        run: |
          # Create folders
          mkdir -p release/Mac
          mkdir -p release/Windows
          mkdir -p release/Linux
          
          # Move files (and ignore the clutter like .blockmap)
          mv artifacts/*.dmg release/Mac/ 2>/dev/null || true
          mv artifacts/*.exe release/Windows/ 2>/dev/null || true
          mv artifacts/*.AppImage release/Linux/ 2>/dev/null || true
          mv artifacts/MESOELFY_OS_Itch_Upload_Ready.zip release/

          # Zip the folders
          cd release
          zip -r MESOELFY_OS_Mac.zip Mac
          zip -r MESOELFY_OS_Windows.zip Windows
          zip -r MESOELFY_OS_Linux.zip Linux
          
          # Remove the folders now that they are zipped
          rm -rf Mac Windows Linux

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/MESOELFY_OS_Mac.zip
            release/MESOELFY_OS_Windows.zip
            release/MESOELFY_OS_Linux.zip
            release/MESOELFY_OS_Itch_Upload_Ready.zip
          draft: false
          prerelease: false
          name: "MESOELFY_OS ${{ github.ref_name }}"
          body: |
            ### // SYSTEM_UPDATE: ${{ github.ref_name }}
            
            **// STANDALONE APPS (OFFLINE)**
            *Contains the game wrapped in a Chromium engine (Electron) for max performance.*
            *You're basically downloading a lite version of the Chrome browser to run the game.*
            *(Approx 200-400MB)*

            *   **Mac:** Download `MESOELFY_OS_Mac.zip`.
                *   *Note: If you see a security warning, Right-Click the App -> Select "Open".*
            *   **Windows:** Download `MESOELFY_OS_Windows.zip`. Double-click to run.
            *   **Linux:** Download `MESOELFY_OS_Linux.zip`.

            ---

            **// WEB BUILD (HTML5)**
            *   **File:** `MESOELFY_OS_Itch_Upload_Ready.zip`
            *   **Usage:** Strictly for uploading to platforms like Itch.io or Newgrounds to host the game online. 
            *   *Included for those who wish to inspect the compiled asset structure for learning purposes.*

            ---

            **// LOCAL HOST EXPERIENCE (SOURCE)**
            *   **File:** `Source code (zip)` (Below)
            *   **Usage:** Run the full project on your machine.
            *   **Why `npm`?** You can't just open an HTML file anymore. This project uses complex 3D rendering that requires a local server. Think of `npm` as the "App Store" for codeâ€”it installs the engine needed to run the site.
            *   **Instructions (It's very easy):**
                1. Unzip the source code.
                2. Open your terminal **inside that specific folder**.
                3. Type `npm install` (this downloads the engine).
                4. Type `npm run dev` (this starts the server).
                5. Open `http://localhost:3000` in any browser, but **Chrome will work the best**.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
